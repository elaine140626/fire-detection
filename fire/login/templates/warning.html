{% extends 'base.html' %}
{% load staticfiles %}

{% block title%}告警分析{% endblock %}

{% block extern_file %}
    <link rel="stylesheet" href="{% static 'lib/datetimepicker/datetimepicker.min.css' %}">
{% endblock %}

{% block main_body %}
    <div class="warning-body center">
        <div class="warning-content">
            <div class="tbl-header">
                <table cellpadding="0" cellspacing="0" border="0" class="my-table">
                    <thead>
                    <tr>
                        {#                        <th>编号</th>#}
                        <th class="my-th">
                            <label for="warning-date">
                                日期
                                <input id="warning-date" type="text" class="form-control form-date text-center" placeholder="选择或者输入一个日期：yyyy-MM-dd">
                            </label>
                        </th>
                        <th class="my-th">
                            <label for="warning-info">
                                预警详情
                            </label>

                        </th>
                        <th class="my-th">
                            <label for="warning-device">
                                设备编号
                            </label>
                            <select name="device" id="warning-device" class="form-control chosen-selected text-center">
                                <option value="all">所有设备</option>
                                <option value="2">none</option>
                            </select>

                        </th>
                        <th class="my-th">
                            <label for="">设备标识</label>
                        </th>
                        <th class="my-th">
                            <label for="warning-state">
                                审核状态
                            </label>
                            <select name="state" id="warning-state" class="form-control chosen-selected text-center">
                                <option value="all" class="text-center">所有</option>
                                <option value="true" class="text-center">已审核</option>
                                <option value="false" class="text-center">未审核</option>
                            </select>
                        </th>
                        <th class="my-th">
                            <label for="warning-img">
                                预警图片
                            </label>
                        </th>
                    </tr>
                    </thead>
                </table>
            </div>
            <div class="tbl-content" id="warning-table">
                <table cellpadding="0" cellspacing="0" border="0" class="my-table">
                    <tbody id="add-tr">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="warning-bar">

        </div>
    </div>
{% endblock %}

{% block script %}
    <script src=" {% static 'js/warning.js' %}"></script>
    <script src="//code.jquery.com/jquery-1.11.0.min.js" type="text/javascript"></script>
    <script src="{% static 'js/zui.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'lib/selectable/zui.selectable.min.js' %}"></script>
    <script src="{% static  'lib/datetimepicker/datetimepicker.min.js' %}"></script>
    <script>

        var UserMessageList = {{ user_message_list|safe }};

        var addTr = document.getElementById('add-tr');



        function showFloating(message,success) {
            new $.zui.Messager(message,{
                    type:success?'success':'warning',
                    icon:success?'heart':'bug'
                }
            ).show();
        }
        function ListRender(){

            let flag = true;

            for(let i=0; i < UserMessageList.length; i++){
                flag = false;
                let theNumber = document.createElement('td'),
                    theDate = document.createElement('td'),
                    theInfo = document.createElement('td'),
                    DeviceNumber = document.createElement('td'),
                    DeviceHint = document.createElement('td'),
                    theStatus = document.createElement('td'),
                    thePic = document.createElement('td'),
                    realPic = document.createElement('img');

                let theTd = document.createElement('tr');

                let Node = UserMessageList[i];
                theNumber.innerText = Node['id'];
                theNumber.className = 'my-td';
                theDate.innerText = Node['c_time'];
                theDate.className = 'my-td';
                theInfo.innerText = Node['content'];
                theInfo.className = 'my-td';
                DeviceNumber.innerText = Node['device_number'];
                DeviceNumber.className = 'my-td';
                DeviceHint.innerText = Node['device_hint'];
                DeviceHint.className = 'my-td';
                theStatus.innerText  = (Node['deal'] ? '已审核':'未审核');
                theStatus.className = 'my-td';
                realPic.src = Node['img_url'];
                realPic.className = 'my-td';
                thePic.appendChild(realPic);
                {#let list = [theNumber,theDate,theInfo,DeviceNumber,DeviceHint,theStatus,thePic];#}

                {#theTd.appendChild(theNumber);#}
                theTd.appendChild(theDate);
                theTd.appendChild(theInfo);
                theTd.appendChild(DeviceNumber);
                theTd.appendChild(DeviceHint);
                theTd.appendChild(theStatus);
                theTd.appendChild(thePic);

                theTd.setAttribute('data-state',Node['deal']);
                theTd.setAttribute('data-id', Node['id']);
                theTd.setAttribute('data-date', Node['c_time']);
                theTd.setAttribute('data-device', Node['device_number']);

                addTr.appendChild(theTd);
            }
            if(flag) {
                showFloating("没有查询到对应数据",false);
            }
            else {
                showFloating('查询成功', true);
            }
        }
        function reRender(Date, Device, State) {
            var mySelectable = $('#add-tr').data('zui.selectable');
            mySelectable.unselect();
            let flag =true;
            for(let i=0; i < addTr.children.length; i++)
            {
                if ((State === "all" || State === addTr.children[i].dataset.state) &&
                    (Date === "" || Date === addTr.children[i].dataset.date) &&
                    (Device === 'all' || Device === addTr.children[i].dataset.device)) {
                    flag = false;
                    addTr.children[i].style.display = "";
                    console.log(' ' + addTr.children[i].dataset.state + addTr.children[i].dataset.date + addTr.children[i].dataset.device);
                }
                else{
                    addTr.children[i].style.display = "none";
                }
            }
            rebind();
        }

        ListRender();
        rebind();

        $('#add-tr').selectable({
            selector: 'tr',
            select:function (e) {
                console.log(e.id + e.selected.length);
                console.log(e.selected);
            }
        });

        // 仅选择日期

        var date = document.querySelector('#warning-date'),
            device = document.querySelector('#warning-device'),
            state = document.querySelector('#warning-state');

        $(".form-date").datetimepicker(
            {
                language:  "zh-CN",
                weekStart: 1,
                todayBtn:  1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                minView: 2,
                forceParse: 0,
                format: "yyyy-mm-dd"
            }).on('changeDate', function (e) {
            reRender(date.value, device.value, state.value);
        });

        state.addEventListener('change',(e)=>{
            reRender(date.value, device.value, state.value);
        });
        device.addEventListener('change',(e)=>{
            reRender(date.value, device.value, state.value);
        });


    </script>
{% endblock %}